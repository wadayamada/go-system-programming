# 学んだこと

# 仮想化
- 普通のOS(ホストOS)の上にハードウェアをエミュレーションする仮想化するためのソフトウェアを用意して、その上にゲストOSをインストールする方式
  - QEMU, VMWareなどの仮想化ソフトウェアがある

主な方式は2種類
- エミュレーション方式: CPUを完全にエミュレーションすることで、他のハードウェア用のソフトウェアも動かせる。新しい高性能なCPUで古いCPU用のソフトウェアを動かしたりするのに使う。パフォーマンスは落ちる
- ネイティブ方式: 同じアーキテクチャのCPUに限定されるが、パフォーマンスは良い

- ゲストOSからホストOSを自由に呼べたら、仮想化が壊れちゃって困るので、ハイパーバイザが対応する必要がある
  - 素朴な方法だと、ゲストOSによる特権命令のたびにハイパーバイザが割り込んで処理を行っていたため、オーバーヘッドが大きかった
- Intel系CPUには様々な仮想化支援機能が追加されたことにより、ネイティブに近い速度が出るようになった
  - VT-x: ゲストOSが特権命令を実行すると、仮想環境を意識したハイパーバイザー用OSモードでCPUを実行できるやつ
    - ハイパーバイザーのエミュレート処理が不要になる
  - 拡張ページテーブル: ゲストのメモリアドレスとホストのメモリアドレスを変換
  - VT-d: 外部デバイスとのアクセスをホストOSを介さずにできる
  - VT-c: ネットワークの仮想化

- proxmox
  - 仮想化技術が統合されたOS
  - Linuxにカーネルに埋め込まれたKVMというハイパーバイザを使ってる
    - CPUの仮想化支援機能を使える
  - QEMUも使ってる
    - エミュレータ
    - 主な仮想化処理はKVMに任せて、QEMUはデバイスエミュレーションや仮想マシンの初期化・管理
  - 複数のproxmoxノードでクラスター化とかできる
- Amazon EC2もKVMをベースとして、専用のASICを組み合わせた、nitro systemという仮想化機構を使っており、ネイティブに近い速度が出てる
  - ASIC: 特定用途のために設計された専用ハードウェアチップ

# 準仮想化
- 完全仮想化はゲストOSが仮想化されてることを全く意識する必要がなかった。他に影響のある処理をしようとすると、ハイパーバイザが割り込み、その処理を代行するから
- 準仮想化はゲストOSが仮想化を意識して、他に影響のある処理の代わりにhypercallでハイパーバイザを呼ぶ。Windowsなど外部からカスタムがしにくいOSの場合、開発元の協力がないと使えなかったりする。
- 完全仮想化がCPUの仮想化支援機能により高速化されたため、あまり使われなくなった

# コンテナ
- Dockerのコアはlibcontainerというgo製のライブラリ
- Linuxカーネルのコントロールグループと名前空間という機能で実現される
- コントロールグループ: CPU、メモリ、ネットワーク、デバイスファイルなどの使用量とアクセスを制限できる
- 名前空間: プロセス、ネットワーク、ファイルシステム、ユーザーなどの名前空間を分離できる
- Linuxではコンテナだけ使うが、MacOS、Windowsでは仮想化の仕組みでLinuxを動かして、その上でコンテナを動かしてる
  - そのため、Rancher DesktopをMacOSで使う時は、内部でQEMUを使っている

# Windows Subsystem for Linux 2
- 準仮想化みたいにWindowsもLinuxカーネルもハイパーバイザの上に乗っている
- ただ、Linuxカーネルは本物の完全なLinuxカーネルが動いてるため、そういう意味では仮想化。DockerもLinux用のものが動かせる。
- LinuxとWindowsはメモリを共有しており、Linuxは必要に応じて、Windowsにメモリを要求してメモリを取得してる
- お互いのファイルシステムはネットワークファイルシステムを通じて見られる。ただネットワークアクセスになるのでパフォーマンスは落ちる
- ネットワークも別々で、同じポートを使ってもエラーにならないが、お互いにアクセスもできる

# ネットワークファイルシステム
- SMB
  - リモートにあるファイルをローカルにあるように扱える。ファイルサーバーを立てて、みんなで使う的な
  - HTTPとかと同じTCPをベースにしたアプリケーションレイヤーのプロトコル
  - NFSも同様にネットワークファイルシステム用の具体的なプロコトルの1つ
  - SambaはSMBを実装して、linuxなどで使えるようにしたやつ
- Active Directory: ユーザー管理できる。アカウント作ったり、権限管理したり、ユーザー情報をもったり
- kerberosはユーザー認証のプロトコルで、ADで採用されてる

# 面白かったこと

# わからなかったこと
- コンテナの実装はスキップ